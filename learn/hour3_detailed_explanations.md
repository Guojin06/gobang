# ç¬¬3å°æ—¶ - æ ¸å¿ƒæŠ€æœ¯è¯¦ç»†è§£æ

## ğŸ¯ æ‚¨çš„æ ¸å¿ƒé—®é¢˜è§£ç­”

### 1. ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ `std::make_pair`ï¼Ÿ

#### ğŸ” é—®é¢˜åˆ†æ
```cpp
_session.insert(std::make_pair(_next_ssid, ssp));
//               â†‘
//         ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
```

#### ğŸ’¡ è¯¦ç»†è§£ç­”

**std::make_pair çš„ä½œç”¨ï¼šåˆ›å»ºé”®å€¼å¯¹**

```cpp
// unordered_map çš„æ•°æ®ç»“æ„ï¼š
std::unordered_map<uint64_t, session_ptr> _session;
//                   â†‘         â†‘
//                  é”®ç±»å‹    å€¼ç±»å‹
//                (SessionID) (Sessionæ™ºèƒ½æŒ‡é’ˆ)

// æ’å…¥æ•°æ®éœ€è¦ pair<key, value> ç±»å‹ï¼š
std::pair<uint64_t, session_ptr> data_pair;
```

#### ğŸ—ï¸ ä¸‰ç§åˆ›å»ºpairçš„æ–¹æ³•å¯¹æ¯”

```cpp
// æ–¹æ³•1ï¼šä½¿ç”¨ make_pair (æ¨è)
_session.insert(std::make_pair(_next_ssid, ssp));

// æ–¹æ³•2ï¼šç›´æ¥æ„é€  pair
_session.insert(std::pair<uint64_t, session_ptr>(_next_ssid, ssp));

// æ–¹æ³•3ï¼šä½¿ç”¨èŠ±æ‹¬å·åˆå§‹åŒ– (C++11)
_session.insert({_next_ssid, ssp});

// make_pair çš„ä¼˜åŠ¿ï¼š
// 1. è‡ªåŠ¨æ¨å¯¼ç±»å‹ï¼Œä¸ç”¨å†™å¤æ‚çš„ç±»å‹å
// 2. ä»£ç æ›´ç®€æ´æ˜“è¯»
// 3. ä¸å®¹æ˜“å‡ºé”™
```

#### ğŸ ç”Ÿæ´»ç±»æ¯”ï¼šç”µè¯ç°¿
```
ä¼ ç»Ÿç”µè¯ç°¿æ’å…¥è”ç³»äººï¼š
å§“åï¼šå¼ ä¸‰    ç”µè¯ï¼š13812345678
 â†‘              â†‘
é”®(Key)        å€¼(Value)

std::make_pair("å¼ ä¸‰", "13812345678")
ç›¸å½“äºåˆ›å»ºä¸€ä¸ª [å§“å-ç”µè¯] çš„æ¡ç›®
```

---

### 2. å˜é‡å«ä¹‰è¯¦ç»†è§£æ

#### ğŸ“ æ ¸å¿ƒå˜é‡ä¸€è§ˆè¡¨

| å˜é‡å | ç±»å‹ | å«ä¹‰ | ç”Ÿæ´»ç±»æ¯” |
|--------|------|------|----------|
| `_ssid` | `uint64_t` | Sessionæ ‡è¯†ç¬¦ | æˆ¿å¡å·ç  |
| `_uid` | `uint64_t` | ç”¨æˆ·ID | èº«ä»½è¯å· |
| `_statu` | `ss_statu` | ç™»å½•çŠ¶æ€ | æˆ¿å¡æ¿€æ´»çŠ¶æ€ |
| `_tp` | `wsserver_t::timer_ptr` | å®šæ—¶å™¨æ™ºèƒ½æŒ‡é’ˆ | æˆ¿å¡è¿‡æœŸæé†’å™¨ |
| `_next_ssid` | `uint64_t` | ä¸‹ä¸€ä¸ªå¯ç”¨SessionID | æˆ¿å¡å·ç”Ÿæˆå™¨ |
| `_session` | `unordered_map` | Sessionå­˜å‚¨å®¹å™¨ | æˆ¿å¡ç®¡ç†ç³»ç»Ÿ |
| `ssp` | `session_ptr` | Sessionæ™ºèƒ½æŒ‡é’ˆ | æˆ¿å¡çš„å®‰å…¨å¥æŸ„ |

#### ğŸ¨ é…’åº—ç®¡ç†ç³»ç»Ÿç±»æ¯”

```cpp
class hotel_manager {  // é…’åº—ç®¡ç†ç³»ç»Ÿ
private:
    uint64_t _next_room_id;                    // ä¸‹ä¸€ä¸ªæˆ¿é—´å·
    std::unordered_map<uint64_t, room_ptr> _rooms;  // æˆ¿é—´ç®¡ç†å®¹å™¨
    //                   â†‘         â†‘
    //                æˆ¿é—´å·      æˆ¿é—´æ™ºèƒ½æŒ‡é’ˆ
};

// åˆ†é…æˆ¿é—´æ—¶ï¼š
room_ptr new_room = create_room(guest_id);
_rooms.insert(std::make_pair(_next_room_id, new_room));
//              åˆ›å»º [æˆ¿é—´å· - æˆ¿é—´æŒ‡é’ˆ] çš„é”®å€¼å¯¹
```

---

### 3. ä»€ä¹ˆæ˜¯"ç®¡ç†å®¹å™¨"ï¼Ÿ

#### ğŸ—‚ï¸ ç®¡ç†å®¹å™¨æ¦‚å¿µ

```cpp
std::unordered_map<uint64_t, session_ptr> _session;
//      â†‘
//   è¿™å°±æ˜¯ç®¡ç†å®¹å™¨
```

**ç®¡ç†å®¹å™¨çš„ä½œç”¨ï¼š**
1. **å­˜å‚¨**ï¼šä¿å­˜æ‰€æœ‰æ´»è·ƒçš„Session
2. **æŸ¥æ‰¾**ï¼šé€šè¿‡SessionIDå¿«é€Ÿæ‰¾åˆ°å¯¹åº”Session
3. **ç®¡ç†**ï¼šç»Ÿä¸€ç®¡ç†Sessionçš„ç”Ÿå‘½å‘¨æœŸ

#### ğŸ“š å®¹å™¨ç±»å‹é€‰æ‹©åˆ†æ

```cpp
// ä¸ºä»€ä¹ˆé€‰æ‹© unordered_map è€Œä¸æ˜¯å…¶ä»–å®¹å™¨ï¼Ÿ

// éœ€æ±‚åˆ†æï¼š
1. éœ€è¦é€šè¿‡ SessionID æŸ¥æ‰¾ Session  â†’ éœ€è¦å…³è”å®¹å™¨
2. æŸ¥æ‰¾é¢‘ç‡éå¸¸é«˜                   â†’ éœ€è¦å¿«é€ŸæŸ¥æ‰¾ O(1)
3. SessionID æ²¡æœ‰é¡ºåºè¦æ±‚            â†’ ä¸éœ€è¦æ’åº
4. éœ€è¦é¢‘ç¹æ’å…¥/åˆ é™¤                â†’ éœ€è¦é«˜æ•ˆçš„æ’å…¥/åˆ é™¤

// å®¹å™¨æ€§èƒ½å¯¹æ¯”ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     å®¹å™¨ç±»å‹     â”‚ æŸ¥æ‰¾å¤æ‚åº¦â”‚æ’å…¥å¤æ‚åº¦â”‚å†…å­˜å¼€é”€â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ vector          â”‚   O(n)   â”‚   O(n)   â”‚  æœ€å°‘  â”‚
â”‚ map             â”‚ O(log n) â”‚ O(log n) â”‚  ä¸­ç­‰  â”‚
â”‚ unordered_map   â”‚   O(1)   â”‚   O(1)   â”‚  è¾ƒå¤š  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç»“è®ºï¼šunordered_map æœ€é€‚åˆï¼
```

#### ğŸª å•†åº—ç®¡ç†ç±»æ¯”

```cpp
// è¶…å¸‚å•†å“ç®¡ç†ç³»ç»Ÿï¼š
std::unordered_map<string, product> store_inventory;
//                   â†‘        â†‘
//                 æ¡å½¢ç     å•†å“ä¿¡æ¯

// é¡¾å®¢ç»“è´¦æ—¶æ‰«ææ¡å½¢ç ï¼š
string barcode = scan_product();
auto product = store_inventory.find(barcode);  // O(1) å¿«é€ŸæŸ¥æ‰¾
if (product != store_inventory.end()) {
    cout << "å•†å“ï¼š" << product->second.name 
         << " ä»·æ ¼ï¼š" << product->second.price << endl;
}
```

---

### 4. å¼•ç”¨è®¡æ•°ä¸ºä»€ä¹ˆreturnäº†è¿˜+1ï¼Ÿ

#### ğŸ§  æ™ºèƒ½æŒ‡é’ˆå¼•ç”¨è®¡æ•°æœºåˆ¶è¯¦è§£

```cpp
session_ptr create_session(uint64_t uid, ss_statu statu) {
    std::unique_lock<std::mutex> lock(_mutex);
    session_ptr ssp(new session(_next_ssid));  // å¼•ç”¨è®¡æ•° = 1
    
    // ... è®¾ç½®sessionå±æ€§ ...
    
    _session.insert(std::make_pair(_next_ssid, ssp));  // å¼•ç”¨è®¡æ•° = 2
    //                                          â†‘
    //                              å®¹å™¨ä¸­å­˜äº†ä¸€ä»½å‰¯æœ¬
    
    _next_ssid++;
    return ssp;  // è¿”å›æ—¶åˆ›å»ºå‰¯æœ¬ï¼Œå¼•ç”¨è®¡æ•° = 3
    //       â†‘
    //   å‡½æ•°è°ƒç”¨è€…æ¥æ”¶åˆ°å‰¯æœ¬
}  // å‡½æ•°ç»“æŸï¼Œå±€éƒ¨å˜é‡sspé”€æ¯ï¼Œå¼•ç”¨è®¡æ•° = 2
```

#### ğŸ“Š å¼•ç”¨è®¡æ•°å˜åŒ–å›¾è§£

```
å¼•ç”¨è®¡æ•°å˜åŒ–è¿‡ç¨‹ï¼š

åˆ›å»º session_ptr ssp          å¼•ç”¨è®¡æ•°: 1
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ssp (å±€éƒ¨)   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â–º Sessionå¯¹è±¡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          (count = 1)

æ’å…¥åˆ°å®¹å™¨ _session        å¼•ç”¨è®¡æ•°: 2
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ssp (å±€éƒ¨)   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â–º Sessionå¯¹è±¡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          (count = 2)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â–²
â”‚_session[id] â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

return ssp ç»™è°ƒç”¨è€…        å¼•ç”¨è®¡æ•°: 3
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ssp (å±€éƒ¨)   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â–º Sessionå¯¹è±¡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          (count = 3)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â–²
â”‚_session[id] â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚calleræ¥æ”¶    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å‡½æ•°ç»“æŸï¼Œsspé”€æ¯          å¼•ç”¨è®¡æ•°: 2
    
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚_session[id] â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â–º Sessionå¯¹è±¡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          (count = 2)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â–²
â”‚calleræŒæœ‰    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ğŸ’° é“¶è¡Œè´¦æˆ·ç±»æ¯”

```cpp
// ç±»æ¯”ï¼šé“¶è¡Œè´¦æˆ·çš„å…±åŒæŒæœ‰
class BankAccount {
public:
    void add_holder() { holder_count++; }      // æ·»åŠ æŒæœ‰äºº
    void remove_holder() { 
        holder_count--; 
        if (holder_count == 0) {
            delete this;  // æ²¡æœ‰æŒæœ‰äººæ—¶å…³é—­è´¦æˆ·
        }
    }
private:
    int holder_count = 0;
};

// shared_ptr çš„å·¥ä½œåŸç†ç±»ä¼¼ï¼š
shared_ptr<Session> ssp(new Session());  // ç¬¬1ä¸ªæŒæœ‰äºº
_session[id] = ssp;                      // ç¬¬2ä¸ªæŒæœ‰äºº
return ssp;                              // ç¬¬3ä¸ªæŒæœ‰äºº

// å½“æŸä¸ªæŒæœ‰äºº"ä¸å†éœ€è¦"æ—¶ï¼Œè‡ªåŠ¨å‡å°‘è®¡æ•°
// å½“æ‰€æœ‰æŒæœ‰äººéƒ½"ä¸å†éœ€è¦"æ—¶ï¼Œè‡ªåŠ¨é‡Šæ”¾å†…å­˜
```

---

### 5. Session å¦‚ä½•ç¼–å†™ä»£ç ï¼Ÿ

#### ğŸ› ï¸ Session ç±»çš„å®Œæ•´å®ç°è¿‡ç¨‹

```cpp
// æ­¥éª¤1ï¼šå®šä¹‰çŠ¶æ€æšä¸¾
typedef enum {
    UNLOGIN,  // æœªç™»å½•çŠ¶æ€
    LOGIN     // å·²ç™»å½•çŠ¶æ€
} ss_statu;

// æ­¥éª¤2ï¼šSession ç±»è®¾è®¡
class session {
private:
    uint64_t _ssid;                    // Sessionå”¯ä¸€æ ‡è¯†ç¬¦
    uint64_t _uid;                     // å…³è”çš„ç”¨æˆ·ID
    ss_statu _statu;                   // å½“å‰ç™»å½•çŠ¶æ€
    wsserver_t::timer_ptr _tp;         // å…³è”çš„å®šæ—¶å™¨
    
public:
    // æ„é€ å‡½æ•°ï¼šåˆ›å»ºSessionæ—¶åˆ†é…ID
    session(uint64_t ssid) : _ssid(ssid) {
        DLOG("SESSION %p è¢«åˆ›å»ºï¼ï¼", this);
    }
    
    // ææ„å‡½æ•°ï¼šSessioné”€æ¯æ—¶è®°å½•æ—¥å¿—
    ~session() {
        DLOG("SESSION %p è¢«é‡Šæ”¾ï¼ï¼", this);
    }
    
    // Getteræ–¹æ³•ï¼šè·å–Sessionä¿¡æ¯
    uint64_t ssid() { return _ssid; }
    uint64_t get_user() { return _uid; }
    bool is_login() { return (_statu == LOGIN); }
    
    // Setteræ–¹æ³•ï¼šè®¾ç½®Sessionä¿¡æ¯
    void set_statu(ss_statu statu) { _statu = statu; }
    void set_user(uint64_t uid) { _uid = uid; }
    
    // å®šæ—¶å™¨ç®¡ç†æ–¹æ³•
    void set_timer(const wsserver_t::timer_ptr &tp) { _tp = tp; }
    wsserver_t::timer_ptr& get_timer() { return _tp; }
};
```

#### ğŸ“ Session ä½¿ç”¨ç¤ºä¾‹

```cpp
// ç”¨æˆ·ç™»å½•æ—¶åˆ›å»ºSession
void handle_user_login(uint64_t user_id) {
    // 1. åˆ›å»ºSession
    session_ptr new_session = session_mgr->create_session(user_id, LOGIN);
    
    // 2. è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆ5åˆ†é’Ÿæ— æ“ä½œè‡ªåŠ¨é€€å‡ºï¼‰
    session_mgr->set_session_expire_time(new_session->ssid(), 300000);
    
    // 3. è¿”å›SessionIDç»™å®¢æˆ·ç«¯
    send_response_to_client("login_success", new_session->ssid());
}

// éªŒè¯ç”¨æˆ·æƒé™æ—¶æŸ¥æ‰¾Session
bool verify_user_permission(uint64_t ssid) {
    session_ptr ssp = session_mgr->get_session_by_ssid(ssid);
    
    // æ£€æŸ¥Sessionæ˜¯å¦å­˜åœ¨ä¸”å·²ç™»å½•
    if (ssp && ssp->is_login()) {
        return true;
    }
    return false;
}

// ç”¨æˆ·è¿›å…¥æ¸¸æˆæ—¶æ›´æ–°SessionçŠ¶æ€
void handle_enter_game(uint64_t ssid) {
    session_ptr ssp = session_mgr->get_session_by_ssid(ssid);
    if (ssp && ssp->is_login()) {
        // æ¸¸æˆä¸­Sessionæ°¸ä¸è¿‡æœŸ
        session_mgr->set_session_expire_time(ssid, SESSION_FOREVER);
    }
}
```

---

### 6. ASIO æ˜¯å¹²ä»€ä¹ˆç”¨çš„ï¼Ÿ

#### ğŸŒ ASIO æ ¸å¿ƒæ¦‚å¿µ

**ASIO = Asynchronous Input/Output (å¼‚æ­¥è¾“å…¥è¾“å‡º)**

```cpp
typedef websocketpp::server<websocketpp::config::asio> wsserver_t;
//                                      â†‘
//                               å¼‚æ­¥IOé…ç½®
```

#### ğŸ”„ åŒæ­¥ vs å¼‚æ­¥ IO å¯¹æ¯”

```cpp
// åŒæ­¥IOæ–¹å¼ (ä¼ ç»Ÿæ–¹å¼)ï¼š
void sync_server() {
    while (true) {
        client = accept_connection();     // é˜»å¡ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥
        data = read_from_client(client);  // é˜»å¡ç­‰å¾…å®¢æˆ·ç«¯æ•°æ®
        response = process_data(data);    // å¤„ç†æ•°æ®
        send_to_client(client, response); // å‘é€å“åº”
    }
    // é—®é¢˜ï¼šä¸€æ¬¡åªèƒ½å¤„ç†ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œæ•ˆç‡ä½
}

// å¼‚æ­¥IOæ–¹å¼ (ASIOæ–¹å¼)ï¼š
void async_server() {
    // æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œä¸é˜»å¡
    server.set_accept_handler(on_new_connection);
    server.set_message_handler(on_receive_message);
    
    server.run();  // äº‹ä»¶å¾ªç¯ï¼Œé«˜æ•ˆå¤„ç†å¤šä¸ªè¿æ¥
}

void on_new_connection(connection_ptr conn) {
    // æ–°è¿æ¥å»ºç«‹æ—¶çš„å›è°ƒ
    cout << "æ–°å®¢æˆ·ç«¯è¿æ¥" << endl;
}

void on_receive_message(connection_ptr conn, string message) {
    // æ”¶åˆ°æ¶ˆæ¯æ—¶çš„å›è°ƒ
    string response = process_message(message);
    conn->send(response);
}
```

#### ğŸ• é¤å…æœåŠ¡ç±»æ¯”

```
åŒæ­¥IOé¤å… (ä¼ ç»Ÿé¤å…)ï¼š           å¼‚æ­¥IOé¤å… (ç°ä»£é¤å…)ï¼š

æœåŠ¡å‘˜A                          æœåŠ¡å‘˜å›¢é˜Ÿ
 â”‚                                â”‚
 â”œâ”€ æ¥å¾…å®¢æˆ·1 (ç­‰å¾…)              â”œâ”€ å®¢æˆ·1æ¥äº† â†’ ç«‹å³å®‰æ’åº§ä½
 â”œâ”€ ç‚¹é¤å®¢æˆ·1 (ç­‰å¾…)              â”œâ”€ å®¢æˆ·2æ¥äº† â†’ ç«‹å³å®‰æ’åº§ä½  
 â”œâ”€ ä¸Šèœå®¢æˆ·1 (ç­‰å¾…)              â”œâ”€ å®¢æˆ·1ç‚¹é¤å®Œæˆ â†’ é€šçŸ¥å¨æˆ¿
 â”œâ”€ ç»“è´¦å®¢æˆ·1 (ç­‰å¾…)              â”œâ”€ å®¢æˆ·2ç‚¹é¤å®Œæˆ â†’ é€šçŸ¥å¨æˆ¿
 â”‚                                â”œâ”€ å®¢æˆ·1èœå“å®Œæˆ â†’ ç«‹å³ä¸Šèœ
 â””â”€ å¼€å§‹æ¥å¾…å®¢æˆ·2                 â””â”€ å¤šä¸ªå®¢æˆ·åŒæ—¶æœåŠ¡

æ•ˆç‡ï¼šä¸€æ¬¡åªèƒ½æœåŠ¡ä¸€ä¸ªå®¢æˆ·        æ•ˆç‡ï¼šåŒæ—¶æœåŠ¡å¤šä¸ªå®¢æˆ·
```

#### âš¡ ASIO çš„æ€§èƒ½ä¼˜åŠ¿

```
ä¼ ç»ŸåŒæ­¥æœåŠ¡å™¨ï¼š                  ASIOå¼‚æ­¥æœåŠ¡å™¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯1        â”‚              â”‚  å®¢æˆ·ç«¯1        â”‚
â”‚      â†“         â”‚              â”‚      â†“         â”‚
â”‚ æœåŠ¡å™¨çº¿ç¨‹1     â”‚              â”‚                â”‚
â”‚   (ç­‰å¾…)       â”‚              â”‚   äº‹ä»¶å¾ªç¯     â”‚ â† é«˜æ•ˆï¼
â”‚      â†“         â”‚              â”‚      â†‘         â”‚
â”‚  å“åº”1         â”‚              â”‚  â”Œâ”€ å›è°ƒ1      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  â”œâ”€ å›è°ƒ2      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚  â”œâ”€ å›è°ƒ3      â”‚
â”‚  å®¢æˆ·ç«¯2        â”‚              â”‚  â””â”€ å›è°ƒ4      â”‚
â”‚      â†“         â”‚              â”‚      â†“         â”‚
â”‚ æœåŠ¡å™¨çº¿ç¨‹2     â”‚              â”‚  å®¢æˆ·ç«¯1,2,3,4  â”‚
â”‚   (ç­‰å¾…)       â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚      â†“         â”‚              
â”‚  å“åº”2         â”‚              å†…å­˜å ç”¨ï¼šå°‘
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              CPUæ•ˆç‡ï¼šé«˜
                                å¹¶å‘èƒ½åŠ›ï¼šå¼º
å†…å­˜å ç”¨ï¼šå¤š(æ¯çº¿ç¨‹1-8MB)        
CPUåˆ‡æ¢ï¼šé¢‘ç¹                   
å¹¶å‘èƒ½åŠ›ï¼šå—é™äºçº¿ç¨‹æ•°           
```

---

### 7. WebSocketPP ç±»å‹å®šä¹‰è¯¦è§£

#### ğŸ”§ typedef è¯­å¥åˆ†æ

```cpp
typedef websocketpp::server<websocketpp::config::asio> wsserver_t;
//  â†‘       â†‘                    â†‘                      â†‘
// å…³é”®å­—  åŸºç¡€ç±»å‹              æ¨¡æ¿å‚æ•°                åˆ«å
```

#### ğŸ§© é€æ­¥æ‹†è§£

```cpp
// ç¬¬1æ­¥ï¼šåŸºç¡€ç±»å‹
websocketpp::server
//    â†‘        â†‘
//  å‘½åç©ºé—´   æœåŠ¡å™¨ç±»

// ç¬¬2æ­¥ï¼šæ¨¡æ¿å‚æ•°
websocketpp::config::asio
//    â†‘       â†‘      â†‘
//  å‘½åç©ºé—´  é…ç½®   å¼‚æ­¥IO

// ç¬¬3æ­¥ï¼šå®Œæ•´ç±»å‹
websocketpp::server<websocketpp::config::asio>
// å«ä¹‰ï¼šä½¿ç”¨å¼‚æ­¥IOé…ç½®çš„WebSocketæœåŠ¡å™¨

// ç¬¬4æ­¥ï¼šç±»å‹åˆ«å
typedef websocketpp::server<websocketpp::config::asio> wsserver_t;
// å«ä¹‰ï¼šå°†å¤æ‚ç±»å‹å®šä¹‰ä¸ºç®€å•åˆ«å wsserver_t
```

#### ğŸ“š ç±»æ¯”ç†è§£

```cpp
// ç±»ä¼¼äºç»™äººèµ·å¤–å·ï¼š
typedef std::shared_ptr<session> session_ptr;
//        â†‘                      â†‘
//    çœŸå®å…¨å                  å¤–å·

// ä½¿ç”¨æ•ˆæœå¯¹æ¯”ï¼š
// ä½¿ç”¨å…¨åï¼ˆå¤æ‚ï¼‰ï¼š
std::shared_ptr<session> my_session = create_session();

// ä½¿ç”¨åˆ«åï¼ˆç®€æ´ï¼‰ï¼š
session_ptr my_session = create_session();

// WebSocketæœåŠ¡å™¨ä¹Ÿæ˜¯åŒæ ·é“ç†ï¼š
// ä½¿ç”¨å…¨åï¼ˆå¤æ‚ï¼‰ï¼š
websocketpp::server<websocketpp::config::asio> my_server;

// ä½¿ç”¨åˆ«åï¼ˆç®€æ´ï¼‰ï¼š
wsserver_t my_server;
```

#### ğŸ›ï¸ å…¶ä»–é…ç½®é€‰é¡¹

```cpp
// WebSocketPP æä¾›å¤šç§é…ç½®ï¼š

// 1. æ— TLSçš„å¼‚æ­¥IO (é¡¹ç›®ä½¿ç”¨çš„)
typedef websocketpp::server<websocketpp::config::asio> wsserver_t;

// 2. å¸¦TLSçš„å¼‚æ­¥IO (HTTPS/WSS)
typedef websocketpp::server<websocketpp::config::asio_tls> wss_server_t;

// 3. è°ƒè¯•æ¨¡å¼é…ç½®
typedef websocketpp::server<websocketpp::config::debug_asio> debug_server_t;

// é€‰æ‹© asio è€Œä¸æ˜¯ asio_tls çš„åŸå› ï¼š
// - é¡¹ç›®æ˜¯å±€åŸŸç½‘æ¸¸æˆï¼Œä¸éœ€è¦åŠ å¯†
// - TLSä¼šå¢åŠ æ€§èƒ½å¼€é”€
// - ç®€åŒ–éƒ¨ç½²å’Œè°ƒè¯•
```

---

### 8. ä»€ä¹ˆæ˜¯ TLSï¼Ÿ

#### ğŸ” TLS åŸºæœ¬æ¦‚å¿µ

**TLS = Transport Layer Security (ä¼ è¾“å±‚å®‰å…¨åè®®)**

```
HTTP  vs  HTTPS
 â†“         â†“
æ˜æ–‡ä¼ è¾“   åŠ å¯†ä¼ è¾“(TLS)

WS    vs  WSS  
 â†“         â†“
æ˜æ–‡ä¼ è¾“   åŠ å¯†ä¼ è¾“(TLS)
```

#### ğŸ”“ åŠ å¯† vs æ˜æ–‡å¯¹æ¯”

```
æ˜æ–‡ä¼ è¾“ (WS/HTTP)ï¼š              åŠ å¯†ä¼ è¾“ (WSS/HTTPS)ï¼š

å®¢æˆ·ç«¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º æœåŠ¡å™¨          å®¢æˆ·ç«¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º æœåŠ¡å™¨
"ç”¨æˆ·å:admin"                    "X#$@%K*9&^%"
"å¯†ç :123456"                     "M!@#$%^&*()"
                                        â†‘
ä¸­é—´äººå¯ä»¥ç›´æ¥çœ‹åˆ°                   ä¸­é—´äººçœ‹åˆ°çš„æ˜¯ä¹±ç 
```

#### ğŸª è´­ç‰©ç½‘ç«™ç±»æ¯”

```
æ™®é€šå•†åº— (HTTP/WS)ï¼š               é“¶è¡Œ/è´­ç‰©ç½‘ç«™ (HTTPS/WSS)ï¼š

é¡¾å®¢å¯¹åº—å‘˜è¯´ï¼š                     é¡¾å®¢å¯¹åº—å‘˜è¯´ï¼š
"æˆ‘çš„é“¶è¡Œå¡å·æ˜¯1234567890"         "åŠ å¯†åçš„ä¿¡æ¯ï¼š@#$%^&*()"
       â†“                                â†“
  æ—è¾¹çš„äººéƒ½èƒ½å¬åˆ°                 æ—è¾¹çš„äººå¬ä¸æ‡‚åœ¨è¯´ä»€ä¹ˆ
     (ä¸å®‰å…¨)                          (å®‰å…¨)
```

#### âš–ï¸ ä¸ºä»€ä¹ˆé¡¹ç›®é€‰æ‹©ä¸ä½¿ç”¨TLSï¼Ÿ

```cpp
// é¡¹ç›®ä½¿ç”¨ asio è€Œä¸æ˜¯ asio_tls çš„åŸå› ï¼š

1. åº”ç”¨åœºæ™¯ï¼š
   - äº”å­æ£‹æ¸¸æˆï¼Œå±€åŸŸç½‘ç¯å¢ƒ
   - ä¸æ¶‰åŠæ•æ„Ÿä¿¡æ¯ä¼ è¾“
   - æ€§èƒ½è¦æ±‚é«˜ï¼Œå»¶è¿Ÿè¦æ±‚ä½

2. å¼€å‘ç®€åŒ–ï¼š
   - ä¸éœ€è¦SSLè¯ä¹¦é…ç½®
   - è°ƒè¯•æ›´ç®€å•
   - éƒ¨ç½²æ›´å®¹æ˜“

3. æ€§èƒ½è€ƒè™‘ï¼š
   - TLSåŠ å¯†/è§£å¯†æœ‰CPUå¼€é”€
   - æ¸¸æˆéœ€è¦å¿«é€Ÿå“åº”
   - å®æ—¶æ€§æ¯”å®‰å…¨æ€§æ›´é‡è¦
```

---

### 9. å›è°ƒæœºåˆ¶è¯¦ç»†è§£æ

#### ğŸ”„ ä»€ä¹ˆæ˜¯å›è°ƒ(Callback)ï¼Ÿ

**å›è°ƒ = "ä½ å…ˆå»åšäº‹ï¼Œåšå®Œäº†æ¥å‘Šè¯‰æˆ‘"**

```cpp
// ä¼ ç»Ÿæ–¹å¼ (åŒæ­¥)ï¼š
void traditional_way() {
    result = do_something();  // ç­‰å¾…å®Œæˆ
    handle_result(result);    // å¤„ç†ç»“æœ
}

// å›è°ƒæ–¹å¼ (å¼‚æ­¥)ï¼š
void callback_way() {
    do_something_async(handle_result);  // æ³¨å†Œå›è°ƒå‡½æ•°
    // ç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…
    // å½“ do_something å®Œæˆæ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨ handle_result
}
```

#### ğŸ“ ç”µè¯é¢„çº¦ç±»æ¯”

```
ä¼ ç»Ÿæ–¹å¼ (åŒæ­¥ç­‰å¾…)ï¼š              å›è°ƒæ–¹å¼ (å¼‚æ­¥é€šçŸ¥)ï¼š

é¡¾å®¢ï¼šåŒ»ç”Ÿï¼Œæˆ‘æƒ³çœ‹ç—…               é¡¾å®¢ï¼šåŒ»ç”Ÿï¼Œæˆ‘æƒ³çœ‹ç—…
åŒ»ç”Ÿï¼šè¯·ç­‰å¾…                     åŒ»ç”Ÿï¼šå¥½çš„ï¼Œè½®åˆ°ä½ æ—¶æˆ‘ä¼šæ‰“ç”µè¯é€šçŸ¥
é¡¾å®¢ï¼š[ä¸€ç›´ç­‰åœ¨åŒ»é™¢]              é¡¾å®¢ï¼š[å›å®¶åšå…¶ä»–äº‹æƒ…]
åŒ»ç”Ÿï¼šè½®åˆ°ä½ äº†                   åŒ»ç”Ÿï¼š[è½®åˆ°æ—¶] æ‰“ç”µè¯ç»™é¡¾å®¢
é¡¾å®¢ï¼šå¥½çš„ï¼Œç°åœ¨çœ‹ç—…              é¡¾å®¢ï¼šæ¥åˆ°ç”µè¯ï¼Œå‰æ¥çœ‹ç—…

æ•ˆç‡ï¼šä½ï¼Œä¸€ç›´å ç”¨èµ„æº            æ•ˆç‡ï¼šé«˜ï¼Œèµ„æºå¾—åˆ°å……åˆ†åˆ©ç”¨
```

#### ğŸ› ï¸ é¡¹ç›®ä¸­çš„å›è°ƒæœºåˆ¶

```cpp
// WebSocketæœåŠ¡å™¨çš„å›è°ƒè®¾ç½®ï¼š
class server {
public:
    void init() {
        // è®¾ç½®å„ç§äº‹ä»¶çš„å›è°ƒå‡½æ•°
        _wssrv.set_http_handler(std::bind(&server::http_callback, this, std::placeholders::_1));
        _wssrv.set_message_handler(std::bind(&server::websocket_callback, this, std::placeholders::_1, std::placeholders::_2));
        //                            â†‘                                          â†‘
        //                       ç»‘å®šæˆå‘˜å‡½æ•°                              å ä½ç¬¦è¡¨ç¤ºå‚æ•°
    }
    
private:
    // HTTPè¯·æ±‚çš„å›è°ƒå‡½æ•°
    void http_callback(websocketpp::connection_hdl hdl) {
        std::cout << "æ”¶åˆ°HTTPè¯·æ±‚" << std::endl;
        // å¤„ç†HTTPè¯·æ±‚é€»è¾‘
    }
    
    // WebSocketæ¶ˆæ¯çš„å›è°ƒå‡½æ•°  
    void websocket_callback(websocketpp::connection_hdl hdl, wsserver_t::message_ptr msg) {
        std::cout << "æ”¶åˆ°WebSocketæ¶ˆæ¯: " << msg->get_payload() << std::endl;
        // å¤„ç†WebSocketæ¶ˆæ¯é€»è¾‘
    }
};
```

#### ğŸ­ std::bind è¯¦ç»†è§£æ

```cpp
std::bind(&server::http_callback, this, std::placeholders::_1)
//  â†‘        â†‘                    â†‘      â†‘
// ç»‘å®šå‡½æ•°  æˆå‘˜å‡½æ•°æŒ‡é’ˆ         å¯¹è±¡   å‚æ•°å ä½ç¬¦

// ç­‰ä»·äºåˆ›å»ºä¸€ä¸ªlambdaï¼š
auto callback = [this](websocketpp::connection_hdl hdl) {
    this->http_callback(hdl);
};
```

#### ğŸ”— å ä½ç¬¦(std::placeholders)è¯¦è§£

```cpp
// åŸå§‹æˆå‘˜å‡½æ•°ç­¾åï¼š
void websocket_callback(websocketpp::connection_hdl hdl, wsserver_t::message_ptr msg);
//                         â†‘                              â†‘
//                      å‚æ•°1                          å‚æ•°2

// std::bind ç»‘å®šï¼š
std::bind(&server::websocket_callback, this, std::placeholders::_1, std::placeholders::_2)
//                                            â†‘                      â†‘
//                                         å ä½ç¬¦1                  å ä½ç¬¦2

// å«ä¹‰ï¼š
// _1 è¡¨ç¤ºï¼šè°ƒç”¨æ—¶ä¼ å…¥çš„ç¬¬1ä¸ªå‚æ•°ä¼šä½œä¸º hdl ä¼ ç»™å‡½æ•°
// _2 è¡¨ç¤ºï¼šè°ƒç”¨æ—¶ä¼ å…¥çš„ç¬¬2ä¸ªå‚æ•°ä¼šä½œä¸º msg ä¼ ç»™å‡½æ•°
```

#### ğŸƒ å›è°ƒå‡½æ•°çš„æ‰§è¡Œæµç¨‹

```
WebSocketæœåŠ¡å™¨å›è°ƒæ‰§è¡Œæµç¨‹ï¼š

1. æœåŠ¡å™¨å¯åŠ¨
   _wssrv.run() â”€â”€â–º å¼€å§‹äº‹ä»¶å¾ªç¯
   
2. å®¢æˆ·ç«¯è¿æ¥
   [å®¢æˆ·ç«¯] â”€â”€â–º [æœåŠ¡å™¨æ¥æ”¶è¿æ¥] â”€â”€â–º è‡ªåŠ¨è°ƒç”¨è®¾ç½®å¥½çš„å›è°ƒå‡½æ•°
   
3. å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯  
   [å®¢æˆ·ç«¯å‘é€] â”€â”€â–º [æœåŠ¡å™¨æ¥æ”¶] â”€â”€â–º websocket_callback è¢«è‡ªåŠ¨è°ƒç”¨
   
4. å›è°ƒå‡½æ•°æ‰§è¡Œ
   websocket_callback(hdl, msg) {
       // å¤„ç†æ¶ˆæ¯
       // å‘é€å“åº”
   }
```

---

### 10. å››ç§å®šæ—¶å™¨çŠ¶æ€è½¬æ¢è¯¦è§£

#### â° Sessionå®šæ—¶å™¨çš„å››ç§è½¬æ¢æƒ…å†µ

```cpp
void set_session_expire_time(uint64_t ssid, int ms) {
    session_ptr ssp = get_session_by_ssid(ssid);
    wsserver_t::timer_ptr tp = ssp->get_timer();
    
    // å››ç§æƒ…å†µåˆ†æï¼š
}
```

#### ğŸ“Š çŠ¶æ€è½¬æ¢çŸ©é˜µ

```
å½“å‰çŠ¶æ€ ï¼¼ ç›®æ ‡çŠ¶æ€    â”‚  æ°¸ä¹…å­˜åœ¨  â”‚  å®šæ—¶åˆ é™¤  â”‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      æ°¸ä¹…å­˜åœ¨        â”‚  æƒ…å†µ1    â”‚  æƒ…å†µ2    â”‚
      å®šæ—¶åˆ é™¤        â”‚  æƒ…å†µ3    â”‚  æƒ…å†µ4    â”‚
```

#### ğŸ” æƒ…å†µ1ï¼šæ°¸ä¹… â†’ æ°¸ä¹… (æ— æ“ä½œ)

```cpp
if (tp.get() == nullptr && ms == SESSION_FOREVER) {
    return;  // ä»€ä¹ˆéƒ½ä¸åš
}
```

**åœºæ™¯ï¼š**
```
ç”¨æˆ·å·²ç»åœ¨æ¸¸æˆä¸­ (æ°¸ä¹…Session)
å†æ¬¡è°ƒç”¨è®¾ç½®æ°¸ä¹…å­˜åœ¨
â†’ æ— éœ€ä»»ä½•æ“ä½œï¼Œä¿æŒç°çŠ¶
```

**ç”Ÿæ´»ç±»æ¯”ï¼š**
```
é…’åº—é•¿æœŸä½å®¢ (åŒ…å¹´æˆ¿å®¢)
å†æ¬¡ç”³è¯·é•¿æœŸä½å®¿
â†’ å‰å°ï¼šæ‚¨å·²ç»æ˜¯é•¿æœŸå®¢æˆ·äº†ï¼Œæ— éœ€é‡å¤åŠç†
```

#### ğŸ” æƒ…å†µ2ï¼šæ°¸ä¹… â†’ å®šæ—¶åˆ é™¤

```cpp
if (tp.get() == nullptr && ms != SESSION_FOREVER) {
    // è®¾ç½®æ–°çš„å®šæ—¶å™¨
    wsserver_t::timer_ptr tmp_tp = _server->set_timer(ms, 
        std::bind(&session_manager::remove_session, this, ssid));
    ssp->set_timer(tmp_tp);
}
```

**åœºæ™¯ï¼š**
```
ç”¨æˆ·ä»æ¸¸æˆæˆ¿é—´é€€å‡ºåˆ°å¤§å…
éœ€è¦è®¾ç½®è¶…æ—¶æœºåˆ¶ (æ¯”å¦‚10åˆ†é’Ÿæ— æ“ä½œè‡ªåŠ¨é€€å‡º)
```

**è¯¦ç»†æµç¨‹ï¼š**
```
Step 1: æ£€æµ‹å½“å‰æ— å®šæ—¶å™¨ (tp == nullptr)
Step 2: ç›®æ ‡æ˜¯è®¾ç½®å®šæ—¶å™¨ (ms != SESSION_FOREVER)  
Step 3: åˆ›å»ºæ–°å®šæ—¶å™¨ï¼Œmsæ¯«ç§’åè‡ªåŠ¨åˆ é™¤Session
Step 4: å°†å®šæ—¶å™¨å…³è”åˆ°Session

æ—¶é—´çº¿ï¼š
ç°åœ¨ â”€â”€â–º 10åˆ†é’Ÿå â”€â”€â–º è‡ªåŠ¨åˆ é™¤Session
```

#### ğŸ” æƒ…å†µ3ï¼šå®šæ—¶åˆ é™¤ â†’ æ°¸ä¹…

```cpp
if (tp.get() != nullptr && ms == SESSION_FOREVER) {
    tp->cancel();  // å–æ¶ˆåŸå®šæ—¶å™¨
    ssp->set_timer(wsserver_t::timer_ptr());  // æ¸…ç©ºå®šæ—¶å™¨æŒ‡é’ˆ
    _server->set_timer(0, std::bind(&session_manager::append_session, this, ssp));
}
```

**åœºæ™¯ï¼š**
```
ç”¨æˆ·ä»å¤§å…è¿›å…¥æ¸¸æˆæˆ¿é—´
éœ€è¦å–æ¶ˆè¶…æ—¶æœºåˆ¶ï¼Œé¿å…æ¸¸æˆä¸­é€”è¢«è¸¢å‡º
```

**è¯¦ç»†æµç¨‹ï¼š**
```
Step 1: æ£€æµ‹å½“å‰æœ‰å®šæ—¶å™¨ (tp != nullptr)
Step 2: ç›®æ ‡æ˜¯æ°¸ä¹…å­˜åœ¨ (ms == SESSION_FOREVER)
Step 3: å–æ¶ˆåŸæœ‰çš„å®šæ—¶å™¨
Step 4: æ¸…ç©ºSessionçš„å®šæ—¶å™¨æŒ‡é’ˆ 
Step 5: å¼‚æ­¥é‡æ–°æ·»åŠ Session (é¿å…ç«æ€æ¡ä»¶)

ä¸ºä»€ä¹ˆéœ€è¦é‡æ–°æ·»åŠ ï¼Ÿ
å› ä¸º cancel() ä¸æ˜¯ç«‹å³ç”Ÿæ•ˆçš„ï¼
å¯èƒ½å­˜åœ¨ï¼šcancel()æ‰§è¡Œ â†’ å®šæ—¶å™¨ä»ç„¶è§¦å‘ â†’ Sessionè¢«åˆ é™¤
æ‰€ä»¥éœ€è¦å¼‚æ­¥é‡æ–°æ·»åŠ ï¼Œç¡®ä¿Sessionå­˜åœ¨
```

**ğŸš¨ ç«æ€æ¡ä»¶é—®é¢˜ï¼š**
```
é”™è¯¯çš„å¤„ç†æ–¹å¼ï¼š
ç”¨æˆ·è¿›å…¥æ¸¸æˆæˆ¿é—´ â”€â”€â–º cancelå®šæ—¶å™¨ â”€â”€â–º è®¾ç½®æ°¸ä¹…

å¯èƒ½å‘ç”Ÿçš„é—®é¢˜ï¼š
æ—¶åˆ»1: cancelå®šæ—¶å™¨
æ—¶åˆ»2: å®šæ—¶å™¨è§¦å‘ (cancelä¸æ˜¯ç«‹å³çš„)
æ—¶åˆ»3: Sessionè¢«åˆ é™¤
æ—¶åˆ»4: ç”¨æˆ·å°è¯•æ“ä½œ â†’ Sessionä¸å­˜åœ¨!

æ­£ç¡®çš„å¤„ç†æ–¹å¼ï¼š
cancelå®šæ—¶å™¨ â”€â”€â–º å¼‚æ­¥é‡æ–°æ·»åŠ Session â”€â”€â–º è®¾ç½®æ°¸ä¹…
ç¡®ä¿Sessionä¸€å®šå­˜åœ¨ï¼
```

#### ğŸ” æƒ…å†µ4ï¼šå®šæ—¶åˆ é™¤ â†’ æ–°çš„å®šæ—¶åˆ é™¤

```cpp
if (tp.get() != nullptr && ms != SESSION_FOREVER) {
    tp->cancel();  // å–æ¶ˆåŸå®šæ—¶å™¨
    ssp->set_timer(wsserver_t::timer_ptr());  // æ¸…ç©ºå®šæ—¶å™¨æŒ‡é’ˆ
    _server->set_timer(0, std::bind(&session_manager::append_session, this, ssp));
    
    // è®¾ç½®æ–°çš„å®šæ—¶å™¨
    wsserver_t::timer_ptr tmp_tp = _server->set_timer(ms, 
        std::bind(&session_manager::remove_session, this, ssp->ssid()));
    ssp->set_timer(tmp_tp);
}
```

**åœºæ™¯ï¼š**
```
ç”¨æˆ·åœ¨å¤§å…ä¸­æœ‰æ´»åŠ¨ï¼Œé‡æ–°åˆ·æ–°è¶…æ—¶æ—¶é—´
åŸæ¥5åˆ†é’Ÿååˆ é™¤ â†’ é‡æ–°è®¾ç½®ä¸º10åˆ†é’Ÿååˆ é™¤
```

**è¯¦ç»†æµç¨‹ï¼š**
```
Step 1: å–æ¶ˆåŸæœ‰å®šæ—¶å™¨ (åŸæ¥5åˆ†é’Ÿååˆ é™¤)
Step 2: æ¸…ç©ºå®šæ—¶å™¨æŒ‡é’ˆ
Step 3: å¼‚æ­¥é‡æ–°æ·»åŠ Session (é¿å…ç«æ€)
Step 4: åˆ›å»ºæ–°å®šæ—¶å™¨ (æ–°çš„10åˆ†é’Ÿååˆ é™¤)
Step 5: è®¾ç½®æ–°å®šæ—¶å™¨

æ—¶é—´çº¿ï¼š
åŸè®¡åˆ’: ç°åœ¨ â”€â”€â–º 5åˆ†é’Ÿååˆ é™¤
ç”¨æˆ·æ´»åŠ¨å: ç°åœ¨ â”€â”€â–º 10åˆ†é’Ÿååˆ é™¤ (é‡æ–°è®¡æ—¶)
```

#### ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥é‡æ–°æ·»åŠ ï¼Ÿ

```cpp
_server->set_timer(0, std::bind(&session_manager::append_session, this, ssp));
//                 â†‘                                                      
//            ç«‹å³æ‰§è¡Œ(0æ¯«ç§’å»¶è¿Ÿ)
```

**åŸå› åˆ†æï¼š**
```
WebSocketå®šæ—¶å™¨çš„ç‰¹æ€§ï¼š
1. cancel() è°ƒç”¨åï¼Œå®šæ—¶å™¨ä¸æ˜¯ç«‹å³åœæ­¢
2. å¯èƒ½å­˜åœ¨ "å–æ¶ˆå‘½ä»¤" å’Œ "å®šæ—¶å™¨è§¦å‘" çš„ç«äº‰
3. å¦‚æœå®šæ—¶å™¨å…ˆè§¦å‘ï¼ŒSessionä¼šè¢«åˆ é™¤
4. ä¸ºäº†ç¡®ä¿Sessionå­˜åœ¨ï¼Œéœ€è¦å¼‚æ­¥é‡æ–°æ·»åŠ 

è§£å†³æ–¹æ¡ˆï¼š
ä½¿ç”¨ set_timer(0, ...) åœ¨ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­é‡æ–°æ·»åŠ Session
ç¡®ä¿ cancel() æ“ä½œå®Œå…¨ç”Ÿæ•ˆåå†é‡æ–°æ·»åŠ 
```

---

### 11. Lambda è¡¨è¾¾å¼è¯¦ç»†è§£æ

#### ğŸš€ Lambda åŸºæœ¬è¯­æ³•

```cpp
// åŸºæœ¬è¯­æ³•ï¼š
[æ•è·åˆ—è¡¨](å‚æ•°åˆ—è¡¨) -> è¿”å›ç±»å‹ { å‡½æ•°ä½“ }
//   â†‘          â†‘         â†‘        â†‘
// æ•è·å¤–éƒ¨å˜é‡  å‡½æ•°å‚æ•°   å¯é€‰    å‡½æ•°å®ç°

// æœ€ç®€å•çš„lambdaï¼š
auto hello = []() { cout << "Hello" << endl; };
hello();  // è°ƒç”¨lambdaå‡½æ•°
```

#### ğŸ“ Lambda vs æ™®é€šå‡½æ•°å¯¹æ¯”

```cpp
// æ™®é€šå‡½æ•°å†™æ³•ï¼š
bool compare_by_age(const Student& a, const Student& b) {
    return a.age < b.age;
}
std::sort(students.begin(), students.end(), compare_by_age);

// Lambdaå†™æ³•ï¼š
std::sort(students.begin(), students.end(), 
    [](const Student& a, const Student& b) {
        return a.age < b.age;
    }
);

// Lambdaçš„ä¼˜åŠ¿ï¼š
// 1. ä»£ç æ›´ç´§å‡‘ï¼Œé€»è¾‘æ›´é›†ä¸­
// 2. é¿å…å®šä¹‰åªç”¨ä¸€æ¬¡çš„å‡½æ•°
// 3. å¯ä»¥æ•è·å±€éƒ¨å˜é‡
```

#### ğŸ¯ æ•è·åˆ—è¡¨è¯¦è§£

```cpp
int x = 10;
int y = 20;

// 1. ä¸æ•è·ä»»ä½•å˜é‡
auto lambda1 = []() { 
    // cout << x;  // é”™è¯¯ï¼æ— æ³•è®¿é—®x
};

// 2. æŒ‰å€¼æ•è·
auto lambda2 = [x]() { 
    cout << x;  // æ­£ç¡®ï¼Œxçš„å€¼è¢«å¤åˆ¶åˆ°lambdaä¸­
    // x = 30;  // é”™è¯¯ï¼æŒ‰å€¼æ•è·çš„å˜é‡æ˜¯åªè¯»çš„
};

// 3. æŒ‰å¼•ç”¨æ•è·
auto lambda3 = [&x]() { 
    cout << x;  // æ­£ç¡®ï¼Œå¼•ç”¨åŸå§‹çš„x
    x = 30;     // æ­£ç¡®ï¼Œå¯ä»¥ä¿®æ”¹åŸå§‹çš„x
};

// 4. æ··åˆæ•è·
auto lambda4 = [x, &y]() { 
    cout << x;  // æŒ‰å€¼æ•è·x
    y = 40;     // æŒ‰å¼•ç”¨æ•è·yï¼Œå¯ä»¥ä¿®æ”¹
};

// 5. æ•è·æ‰€æœ‰å˜é‡
auto lambda5 = [=]() {  // æŒ‰å€¼æ•è·æ‰€æœ‰å˜é‡
    cout << x << y;
};

auto lambda6 = [&]() {  // æŒ‰å¼•ç”¨æ•è·æ‰€æœ‰å˜é‡
    x = 50; y = 60;
};

// 6. æ•è·thisæŒ‡é’ˆ (åœ¨ç±»æˆå‘˜å‡½æ•°ä¸­)
class MyClass {
private:
    int value = 100;
public:
    void func() {
        auto lambda = [this]() {
            cout << value;      // è®¿é—®ç±»æˆå‘˜
            this->value = 200;  // ä¿®æ”¹ç±»æˆå‘˜
        };
        lambda();
    }
};
```

#### ğŸ—ï¸ Lambda åœ¨é¡¹ç›®ä¸­çš„å®é™…åº”ç”¨

```cpp
// 1. std::bind çš„ lambda ç­‰ä»·å†™æ³•
// ä½¿ç”¨ std::bindï¼š
_server->set_timer(ms, std::bind(&session_manager::remove_session, this, ssid));

// ç­‰ä»·çš„ lambda å†™æ³•ï¼š
_server->set_timer(ms, [this, ssid]() {
    this->remove_session(ssid);
});

// 2. å¼‚æ­¥å›è°ƒä¸­çš„ lambda
_server->set_timer(0, [this, ssp]() {
    this->append_session(ssp);
});

// 3. å®¹å™¨ç®—æ³•ä¸­çš„ lambda
std::vector<session_ptr> sessions;
// æŸ¥æ‰¾ç‰¹å®šç”¨æˆ·çš„session
auto it = std::find_if(sessions.begin(), sessions.end(),
    [user_id](const session_ptr& ssp) {
        return ssp->get_user() == user_id;
    }
);

// 4. åˆ é™¤è¿‡æœŸsession
sessions.erase(
    std::remove_if(sessions.begin(), sessions.end(),
        [](const session_ptr& ssp) {
            return !ssp->is_login();
        }
    ),
    sessions.end()
);
```

#### ğŸ­ Lambda é«˜çº§ç‰¹æ€§

```cpp
// 1. mutable lambda (å…è®¸ä¿®æ”¹æŒ‰å€¼æ•è·çš„å˜é‡)
int count = 0;
auto counter = [count]() mutable {
    return ++count;  // ä¿®æ”¹lambdaå†…éƒ¨çš„countå‰¯æœ¬
};
cout << counter();  // è¾“å‡º: 1
cout << count;      // è¾“å‡º: 0 (åŸå§‹å˜é‡æœªæ”¹å˜)

// 2. æŒ‡å®šè¿”å›ç±»å‹
auto divide = [](double a, double b) -> double {
    if (b == 0) return 0.0;
    return a / b;
};

// 3. æ³›å‹lambda (C++14)
auto print = [](auto value) {
    cout << value << endl;
};
print(42);        // æ‰“å°æ•´æ•°
print("hello");   // æ‰“å°å­—ç¬¦ä¸²
print(3.14);      // æ‰“å°æµ®ç‚¹æ•°

// 4. åˆå§‹åŒ–æ•è· (C++14)
auto func = [value = expensive_calculation()]() {
    return value * 2;
};
```

#### ğŸ ç”Ÿæ´»ç±»æ¯”ï¼šLambdaå°±åƒä¸´æ—¶å·¥

```
ä¼ ç»Ÿå‡½æ•° = æ­£å¼å‘˜å·¥ï¼š               Lambda = ä¸´æ—¶å·¥ï¼š

éœ€è¦ï¼š                            éœ€è¦ï¼š
1. æ­£å¼æ‹›è˜æµç¨‹                    1. ä¸´æ—¶é›‡ä½£ï¼Œå³ç”¨å³èµ°
2. åˆ†é…å·¥ä½                       2. å°±åœ°å·¥ä½œ
3. é•¿æœŸåˆåŒ                       3. ä»»åŠ¡å®Œæˆå³ç¦»å¼€
4. ç‹¬ç«‹å·¥ä½œç¯å¢ƒ                    4. å¯ä»¥è®¿é—®å½“å‰ç¯å¢ƒçš„èµ„æº

é€‚ç”¨åœºæ™¯ï¼š                        é€‚ç”¨åœºæ™¯ï¼š
é•¿æœŸé‡å¤çš„ä»»åŠ¡                     ä¸€æ¬¡æ€§çš„ç®€å•ä»»åŠ¡
å¤šä¸ªåœ°æ–¹éœ€è¦ä½¿ç”¨                   åªåœ¨å½“å‰ä½ç½®ä½¿ç”¨
å¤æ‚çš„ä¸šåŠ¡é€»è¾‘                     ç®€å•çš„è¾…åŠ©é€»è¾‘
```

#### ğŸš€ Lambda æ€§èƒ½è€ƒè™‘

```cpp
// æ€§èƒ½å¯¹æ¯”ï¼š
// 1. æ™®é€šå‡½æ•°æŒ‡é’ˆ
bool (*func_ptr)(int, int) = [](int a, int b) { return a < b; };

// 2. std::function (é€šç”¨ä½†æœ‰å¼€é”€)
std::function<bool(int, int)> func_obj = [](int a, int b) { return a < b; };

// 3. auto (ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œæœ€å¿«)
auto func_auto = [](int a, int b) { return a < b; };

// æ€§èƒ½æ’åºï¼šauto > å‡½æ•°æŒ‡é’ˆ > std::function
// æ¨èåœ¨æ˜ç¡®ç±»å‹çš„åœºåˆä½¿ç”¨ auto
```

---

## ğŸ¯ æ€»ç»“ï¼šæ‚¨ç°åœ¨åº”è¯¥ç†è§£çš„æ ¸å¿ƒæ¦‚å¿µ

### âœ… **æŠ€æœ¯æŒæ¡æ¸…å•**

1. **std::make_pair**: åˆ›å»ºé”®å€¼å¯¹ï¼Œç”¨äºå®¹å™¨æ’å…¥
2. **ç®¡ç†å®¹å™¨**: unordered_mapæä¾›O(1)æŸ¥æ‰¾æ€§èƒ½
3. **å¼•ç”¨è®¡æ•°**: shared_ptrè‡ªåŠ¨ç®¡ç†å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ
4. **ASIO**: å¼‚æ­¥IOåº“ï¼Œé«˜æ€§èƒ½å¹¶å‘å¤„ç†
5. **WebSocketPP**: åŸºäºæ¨¡æ¿çš„WebSocketåº“
6. **TLS**: ä¼ è¾“åŠ å¯†ï¼Œé¡¹ç›®é€‰æ‹©æ˜æ–‡ä¼ è¾“
7. **å›è°ƒæœºåˆ¶**: å¼‚æ­¥ç¼–ç¨‹çš„æ ¸å¿ƒï¼Œäº‹ä»¶é©±åŠ¨
8. **å®šæ—¶å™¨çŠ¶æ€è½¬æ¢**: 4ç§å¤æ‚çš„çŠ¶æ€ç®¡ç†
9. **Lambdaè¡¨è¾¾å¼**: ç°ä»£C++çš„å‡½æ•°å¼ç¼–ç¨‹

### ğŸ“ **é¢è¯•ä»·å€¼ç‚¹**

- **ç³»ç»Ÿè®¾è®¡èƒ½åŠ›**: Sessionç®¡ç†çš„çŠ¶æ€æœºè®¾è®¡
- **æ€§èƒ½ä¼˜åŒ–æ„è¯†**: å®¹å™¨é€‰æ‹©ã€å¼‚æ­¥IOåº”ç”¨
- **å¹¶å‘ç¼–ç¨‹ç†è§£**: å›è°ƒæœºåˆ¶ã€ç«æ€æ¡ä»¶å¤„ç†
- **ç°ä»£C++ç‰¹æ€§**: æ™ºèƒ½æŒ‡é’ˆã€Lambdaã€autoå…³é”®å­—
- **é¡¹ç›®ç»éªŒç§¯ç´¯**: çœŸå®çš„ä¼ä¸šçº§æŠ€æœ¯æ ˆåº”ç”¨

**æ‚¨å¯¹è¿™äº›æ¦‚å¿µè¿˜æœ‰å“ªä¸ªåœ°æ–¹éœ€è¦è¿›ä¸€æ­¥æ¾„æ¸…å—ï¼Ÿæˆ‘ä»¬å¯ä»¥ç»§ç»­æ·±å…¥ï¼Œæˆ–è€…å¼€å§‹ç¬¬3å°æ—¶çš„æŠ€æœ¯æ£€æµ‹ï¼** ğŸš€
